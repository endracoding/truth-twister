<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Tantangan Kejujuran : 3 Benar 1 Salah</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom scrollbar for better appearance */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .statement-input {
            transition: all 0.3s ease;
        }
        .quiz-option {
            cursor: pointer;
            transition: background-color 0.15s, transform 0.15s;
            transform: scale(1);
        }
        .quiz-option:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .correct-answer {
            background-color: #d1fae5; /* green-100 */
            border-color: #10b981; /* green-500 */
        }
        .incorrect-answer {
            background-color: #fee2e2; /* red-100 */
            border-color: #ef4444; /* red-500 */
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .gemini-button {
            @apply text-sm px-3 py-1 bg-purple-100 text-purple-700 rounded-full font-semibold hover:bg-purple-200 transition duration-150;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- Global Message Box (Toast) -->
    <div id="messageBox" 
         class="fixed top-5 right-5 z-[100] p-4 rounded-lg shadow-lg text-white transition-all duration-300 transform scale-0 opacity-0 max-w-sm">
        <!-- Content set by JS -->
    </div>
    
    <!-- Global Loading Indicator -->
    <div id="loadingIndicator" 
         class="fixed inset-0 z-[101] bg-gray-900 bg-opacity-50 flex items-center justify-center hidden">
        <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>

    <!-- Modal Manajemen Data Pegawai (CRUD) -->
    <div id="employeeListModal" class="fixed inset-0 z-50 modal-backdrop hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl max-h-[90vh] rounded-xl shadow-2xl overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0">
            <!-- Modal Header -->
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50">
                <h3 class="text-2xl font-bold text-indigo-800">Manajemen Data Pegawai (CRUD)</h3>
                <button id="closeModalButton" onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                
                <!-- Form Tambah/Edit Pegawai -->
                <div class="p-4 border-2 border-dashed border-indigo-300 rounded-lg bg-white shadow-sm">
                    <h4 id="formTitle" class="text-lg font-semibold text-gray-800 mb-4">Tambah Pegawai Baru</h4>
                    <form id="employeeForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="hidden" id="employeeDocId">
                        
                        <div>
                            <label for="inputName" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="inputName" required placeholder="Cth: Albert Hutagaol"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        
                        <div>
                            <label for="inputId" class="block text-sm font-medium text-gray-700">ID Pegawai</label>
                            <input type="text" id="inputId" required placeholder="Cth: P_022"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 uppercase">
                        </div>
                        
                        <div>
                            <label for="inputUsername" class="block text-sm font-medium text-gray-700">Username</label>
                            <input type="text" id="inputUsername" required placeholder="Cth: albertparasian"
                                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 lowercase">
                        </div>
                        
                        <div class="flex items-end space-x-2">
                            <button type="submit" id="saveEmployeeButton"
                                class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">
                                Simpan
                            </button>
                            <button type="button" id="cancelEditButton" onclick="resetForm()"
                                class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition hidden">
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Table Daftar Pegawai -->
                <table class="min-w-full divide-y divide-gray-200 mt-4 border border-gray-100 rounded-lg overflow-hidden shadow">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pegawai</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Pegawai</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="employeeListTableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">Memuat data pegawai...</td></tr>
                        <!-- Employee list injected here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition">
                    Tutup
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Dialog (Custom Alert/Confirm) -->
    <div id="confirmationDialog" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Konfirmasi</h3>
            <p id="confirmationMessage" class="text-gray-700 mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancel" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">Batal</button>
                <button id="confirmAction" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">Hapus</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal untuk Menampilkan Hasil Gemini -->
    <div id="geminiResultModal" class="fixed inset-0 z-50 modal-backdrop hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg max-h-[70vh] rounded-xl shadow-2xl overflow-hidden flex flex-col transform transition-all duration-300 scale-95 opacity-0">
            <!-- Modal Header -->
            <div class="p-5 border-b flex justify-between items-center bg-purple-50">
                <h3 id="geminiModalTitle" class="text-xl font-bold text-purple-800">✨ Bantuan Ide dari Gemini</h3>
                <button onclick="closeGeminiModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Modal Content -->
            <div id="geminiModalContent" class="p-6 overflow-y-auto flex-1 space-y-4 text-gray-700" style="white-space: pre-wrap;">
                Memuat...
            </div>
            <!-- Modal Footer -->
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="closeGeminiModal()" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">
                    Tutup
                </button>
            </div>
        </div>
    </div>


    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-gray-100">

        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-900">Aplikasi Tantangan Kejujuran : 3 Benar 1 Salah</h1>
            <p class="mt-2 text-gray-600">Modul untuk menginput set empat (4) pernyataan diri: tiga (3) Benar dan satu (1) Salah, sebagai bagian dari Self-Assessment Kebenaran Diri. </p>
        </header>

        <!-- Langkah 1: Validasi Pegawai (Diubah ke Input Username) -->
        <section id="step1" class="mb-10 p-6 bg-indigo-50 rounded-lg border-l-4 border-indigo-600">
            <h2 class="text-xl font-bold text-indigo-800 mb-4">Langkah 1: Validasi Pegawai (Akses Terbatas)</h2>
            <p class="text-sm text-gray-700 mb-4">Masukkan **Username** Anda yang terdaftar di sistem untuk memvalidasi identitas.</p>

            <div class="flex flex-col sm:flex-row gap-3 relative">
                <div class="flex-1 relative">
                    <label for="usernameInput" class="sr-only">Username Pegawai</label>
                    <input type="text" id="usernameInput" placeholder="Ketikkan username Anda (cth: albertparasian)"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 lowercase"
                        autocomplete="off">
                </div>
                
                <button id="validateUsernameButton" 
                    class="w-full sm:w-auto flex-shrink-0 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 transition duration-150">
                    Validasi Username
                </button>
                
                <button id="showEmployeeListButton" onclick="openModal()"
                    class="w-full sm:w-auto flex-shrink-0 px-4 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 transition duration-150">
                    Manajemen Pegawai (CRUD)
                </button>
            </div>

            <p id="selectionStatus" class="mt-3 text-sm font-medium text-red-500">
                ⚠️ Silakan masukkan Username Anda dan tekan Validasi.
            </p>
            <p id="employeeIdDisplay" class="mt-1 text-xs text-gray-500 hidden"></p>

        </section>

        <!-- Langkah 2: Input Pernyataan -->
        <section id="step2" class="opacity-50 pointer-events-none transition-opacity duration-500">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">Langkah 2: Input Pernyataan Tentang Diri Anda</h2>
                <button id="ideaHelperButton" class="gemini-button">
                    ✨ Bantu Saya Cari Ide
                </button>
            </div>
            <p class="text-gray-700 mb-6 border-b pb-4">
                Inputkan empat (4) pernyataan di bawah ini. Komposisi wajib: **3 Pernyataan Benar** dan **1 Pernyataan Salah** tentang diri Anda sendiri.
            </p>

            <div id="statementsContainer" class="space-y-6">
                <!-- Statement 1 (BENAR) -->
                <div class="flex flex-col md:flex-row gap-4 statement-item" data-status="Benar">
                    <div class="flex-1">
                        <label for="stmt1" class="block text-sm font-medium text-gray-700 mb-1">1. Pernyataan Anda</label>
                        <textarea id="stmt1" rows="3" placeholder="Contoh: Saya menguasai Microsoft Excel."
                            class="statement-input w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                            required></textarea>
                    </div>
                    <div class="w-full md:w-1/4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status Kebenaran</label>
                        <span class="block w-full p-3 bg-green-100 text-green-700 font-semibold rounded-lg text-center border border-green-300">
                            Pernyataan Benar (Otomatis)
                        </span>
                    </div>
                </div>

                <!-- Statement 2 (BENAR) -->
                <div class="flex flex-col md:flex-row gap-4 statement-item" data-status="Benar">
                    <div class="flex-1">
                        <label for="stmt2" class="block text-sm font-medium text-gray-700 mb-1">2. Pernyataan Anda</label>
                        <textarea id="stmt2" rows="3" placeholder="Contoh: Saya pernah bertugas di luar pulau Jawa."
                            class="statement-input w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                            required></textarea>
                    </div>
                    <div class="w-full md:w-1/4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status Kebenaran</label>
                        <span class="block w-full p-3 bg-green-100 text-green-700 font-semibold rounded-lg text-center border border-green-300">
                            Pernyataan Benar (Otomatis)
                        </span>
                    </div>
                </div>

                <!-- Statement 3 (BENAR) -->
                <div class="flex flex-col md:flex-row gap-4 statement-item" data-status="Benar">
                    <div class="flex-1">
                        <label for="stmt3" class="block text-sm font-medium text-gray-700 mb-1">3. Pernyataan Anda</label>
                        <textarea id="stmt3" rows="3" placeholder="Contoh: Saya lulusan S2."
                            class="statement-input w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                            required></textarea>
                    </div>
                    <div class="w-full md:w-1/4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status Kebenaran</label>
                        <span class="block w-full p-3 bg-green-100 text-green-700 font-semibold rounded-lg text-center border border-green-300">
                            Pernyataan Benar (Otomatis)
                        </span>
                    </div>
                </div>

                <!-- Statement 4 (SALAH) -->
                <div class="flex flex-col md:flex-row gap-4 statement-item" data-status="Salah">
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <label for="stmt4" class="block text-sm font-medium text-gray-700">4. Pernyataan Anda</label>
                            <button id="generateLieButton" class="gemini-button">
                                ✨ Buatkan Pernyataan Salah
                            </button>
                        </div>
                        <textarea id="stmt4" rows="3" placeholder="Contoh: Saya bisa berbicara bahasa Jepang (jika Anda tidak bisa)."
                            class="statement-input w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"
                            required></textarea>
                    </div>
                    <div class="w-full md:w-1/4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status Kebenaran</label>
                        <span class="block w-full p-3 bg-red-100 text-red-700 font-semibold rounded-lg text-center border border-red-300">
                            Pernyataan Salah (Otomatis)
                        </span>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t flex justify-end">
                <button id="submitButton"
                    class="px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Simpan Data Pernyataan
                </button>
            </div>
        </section>

        <!-- Langkah 3: Monitoring Status Pengisian -->
        <section id="step3" class="mt-10 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-6">Langkah 3: Monitoring Status Pengisian</h2>
            <p class="text-gray-600 mb-4">Daftar di bawah menunjukkan status pengisian pernyataan (3 Benar 1 Salah) oleh seluruh pegawai. Status diperbarui secara *real-time*.</p>
            
            <div id="monitoringContainer" class="bg-white rounded-lg shadow overflow-x-auto border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pegawai (ID)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Pengisian</th>
                        </tr>
                    </thead>
                    <tbody id="monitoringTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Monitoring rows will be injected here -->
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat status pengisian...</td></tr>
                    </tbody>
                </table>
                <div class="p-4 text-sm text-gray-600 border-t flex justify-between">
                    <span>Total Pegawai: <span id="totalEmployeesCount">0</span></span>
                    <span>Sudah Mengisi: <span id="submittedCount" class="font-semibold text-green-600">0</span></span>
                </div>
            </div>
        </section>
        
        <!-- Langkah 4: Tantangan Kejujuran (Kuis) - DIBLOKIR SECARA DEFAULT -->
        <section id="step4" class="mt-10 pt-6 border-t border-gray-200 opacity-50 pointer-events-none transition-opacity duration-500">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">Tantangan Kejujuran (Kuis)</h2>
                <div class="flex items-center space-x-4">
                    <div class="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg font-bold shadow-sm">
                        PROGRES: <span id="quizProgressDisplay">0/0</span>
                    </div>
                    <div class="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg font-bold shadow-sm">
                        SKOR ANDA: <span id="userScoreDisplay">0</span> Poin
                    </div>
                </div>
            </div>
            
            <div id="quizArea" class="p-6 bg-gray-50 rounded-xl shadow-inner min-h-[250px] flex flex-col justify-center items-center">
                <!-- Status/Prompt Message -->
                <p id="quizStatus" class="text-lg text-gray-600 mb-6">❌ Akses diblokir. Harap masukkan Username Anda di Langkah 1 dan selesaikan Langkah 2 (Input Pernyataan).</p>

                <!-- NEW START BUTTON -->
                <button id="startQuizButton"
                    class="px-8 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-xl hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed hidden">
                    Mulai Tantangan Kejujuran
                </button>
                
                <div id="quizContent" class="w-full hidden mt-4">
                    <!-- Timer Display -->
                    <div class="mb-6 p-4 bg-white rounded-lg border border-indigo-200 shadow-md">
                        <div class="flex justify-between items-start">
                            <!-- Question Title -->
                            <div>
                                <p class="text-sm font-medium text-indigo-700">PERTANYAAN:</p>
                                <p class="text-xl font-semibold text-gray-800 mt-1">
                                    Pilih SATU pernyataan yang PALING SALAH mengenai Pegawai: <span id="quizEmployeeName" class="text-indigo-600"></span>
                                </p>
                            </div>
                            <!-- Per-Question Timer -->
                            <div class="text-right flex-shrink-0 ml-4">
                                <p class="text-sm font-medium text-gray-500">Waktu:</p>
                                <p id="questionTimerDisplay" class="text-2xl font-bold text-red-600">00:00</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quizOptionsContainer" class="space-y-3">
                        <!-- Options injected here -->
                    </div>
                    
                    <div id="quizFeedback" class="mt-4 p-3 rounded-lg font-semibold text-center hidden"></div>
                    
                    <button id="nextQuizButton" class="mt-6 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 hidden">
                        Lanjut ke Pertanyaan Berikutnya
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Langkah 5: Papan Skor Pegawai (Leaderboard) -->
        <section id="step5" class="mt-10 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-6">Langkah 5: Papan Skor Pegawai (Leaderboard)</h2>
            <p class="text-gray-600 mb-4">Akumulasi skor yang didapatkan setiap pegawai dalam Tantangan Kejujuran (diurutkan berdasarkan skor tertinggi).</p>
            
            <div id="leaderboardContainer" class="bg-white rounded-lg shadow overflow-x-auto border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peringkat</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pegawai (Quiz Taker)</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Skor</th>
                            <!-- Added Time Column -->
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Waktu</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Updated Colspan -->
                        <tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat Papan Skor...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, updateDoc, deleteDoc, query, onSnapshot, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE (WAJIB DIISI) ---
        // PENTING: Jika Anda menjalankan di Tiiny Host/Lingkungan Eksternal, 
        // pastikan Anda mengganti nilai di bawah ini dengan konfigurasi Firebase ASLI Anda.
        const firebaseConfig = {
            apiKey: "AIzaSyABv2USzWH2QA3QNKiJmvCjI2N-IwYkUcM", // GANTI INI
            authDomain: "tantangan.firebaseapp.com", // GANTI INI
            projectId: "tantangan", // GANTI INI
            storageBucket: "tantangan.firebasestorage.app", // GANTI INI
            messagingSenderId: "13124408127", // GANTI INI
            appId: "1:13124408127:web:72db9cfe8a1ba3c3c6f98a", // GANTI INI
            measurementId: "G-7V0MQZ4KDL"
        };

        // --- GANTI NAMA APLIKASI INI (WAJIB DIISI) ---
        const appId = 'tantangan-kejujuran';
        
        // --- END OF CONFIGURATION ---


        let db;
        let auth;
        let userId = 'anon';
        let employeeDisplayName = 'Pengguna Anonim'; 
        let allEmployees = []; 
        let allSubmissions = [];
        let quizzesTakenIds = new Set(); 
        let currentQuizData = null; 
        let currentScore = 0; 
        let selectedEmployee = null; 
        let totalEligibleQuestions = 0; 
        
        // Timer Variables
        let questionTimerInterval = null;
        let questionStartTime = 0;
        let currentQuestionTimeElapsed = 0; // in seconds
        let totalAccumulatedTime = 0; // in seconds
        
        // Firestore Collection Paths
        // Menggunakan variabel global __app_id jika tersedia (untuk lingkungan Canvas)
        const effectiveAppId = typeof __app_id !== 'undefined' ? __app_id : appId;
        const employeeCollectionPath = `/artifacts/${effectiveAppId}/public/data/employees`;
        const submissionCollectionPath = `/artifacts/${effectiveAppId}/public/data/employee_submissions`;
        const userMapCollectionPath = `/artifacts/${effectiveAppId}/public/data/user_map`;
        const leaderboardCollectionPath = `/artifacts/${effectiveAppId}/public/data/quiz_leaderboard`;

        // --- GEMINI API Configuration ---
        // API Key dibiarkan kosong, akan diisi oleh lingkungan Canvas
        const apiKey = ""; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Mock data (Diperbarui dengan daftar lengkap dari P_001 hingga P_021)
        const initialMockEmployees = [
            { name: "Wawan Juswanto", id: "P_001", username: "wawan.juswanto" },
            { name: "Arifudin Miftakhul Huda", id: "P_002", username: "arifudin.miftakhul" },
            { name: "Zalik Fakri", id: "P_003", username: "zalik.fakri" },
            { name: "Sasmika Kusuma", id: "P_004", username: "sasmika.kusuma" },
            { name: "Alfarisi Muslim", id: "P_005", username: "alfarisi.muslim" },
            { name: "Endra Noorhuda", id: "P_006", username: "endra" },
            { name: "Irpan Heryana", id: "P_007", username: "irpanheryana" },
            { name: "Albert Parasian Hutagaol", id: "P_008", username: "albertparasian" },
            { name: "Atitya Pritasari", id: "P_009", username: "atitya" },
            { name: "Dessy Monica Wirsal", id: "P_010", username: "dessy.monica" },
            { name: "Andos Heriyanto Hutahaean", id: "P_011", username: "andos" },
            { name: "Winny Irmarooke", id: "P_012", username: "winny.irmarooke" },
            { name: "Rahmatullah Priyo Kusuma", id: "P_013", username: "rahmatullah.priyo" },
            { name: "Rahmatullah Priyo (Meida)", id: "P_014", username: "meida" },
            { name: "Dyna Fransisca", id: "P_015", username: "dyna.fransisca" },
            { name: "Astika Trisnawati Suprapto", id: "P_016", username: "astika.trisnawati" },
            { name: "Dhanang Jaka Purwandaru", id: "P_017", username: "dhanang.purwandaru" },
            { name: "Dina Septiani", id: "P_018", username: "dina.septiani91" },
            { name: "Ruth Margareth Hotmauli Silitonga", id: "P_019", username: "ruth.silitonga" },
            { name: "Eddy Purwanto", id: "P_020", username: "eddy.purwanto" },
            { name: "Sarah Khairina", id: "P_021", username: "sarah.khairina" }
        ];

        // --- UI UTILITIES (Confim Dialog) ---
        
        let confirmResolver;
        const confirmationDialog = document.getElementById('confirmationDialog');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmAction = document.getElementById('confirmAction');

        function showConfirmation(message, actionText = 'Lanjutkan', actionClass = 'bg-red-600 hover:bg-red-700') {
            confirmationMessage.textContent = message;
            confirmAction.textContent = actionText;
            confirmAction.className = `px-4 py-2 text-white font-semibold rounded-lg transition ${actionClass}`;
            
            confirmationDialog.classList.remove('hidden');

            return new Promise(resolve => {
                confirmResolver = resolve;
            });
        }

        function closeConfirmation() {
            confirmationDialog.classList.add('hidden');
        }

        confirmCancel.addEventListener('click', () => {
            closeConfirmation();
            if (confirmResolver) confirmResolver(false);
        });

        confirmAction.addEventListener('click', () => {
            closeConfirmation();
            if (confirmResolver) confirmResolver(true);
        });


        // --- UI UTILITIES (Message, Loading, and Time Formatters) ---
        function showMessage(message, type = 'success') {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            
            box.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'text-white', 'scale-0', 'opacity-0');
            box.classList.add('scale-100', 'opacity-100');

            if (type === 'success') {
                box.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                box.classList.add('bg-red-500', 'text-white');
            } else {
                box.classList.add('bg-yellow-500', 'text-white');
            }

            // Make error messages stay on screen longer
            const aTimeout = (type === 'error') ? 8000 : 4000; // 8 seconds for errors, 4 for others

            setTimeout(() => {
                box.classList.remove('scale-100', 'opacity-100');
                box.classList.add('scale-0', 'opacity-0');
            }, aTimeout);
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            document.getElementById('submitButton').disabled = show;
            // Nonaktifkan juga tombol Gemini saat loading
            document.getElementById('ideaHelperButton').disabled = show;
            document.getElementById('generateLieButton').disabled = show;
        }

        function updateQuizProgressDisplay() {
            const answeredCount = quizzesTakenIds.size;
            document.getElementById('quizProgressDisplay').textContent = `${answeredCount}/${totalEligibleQuestions}`;
        }
        
        // Time Formatting Utilities
        
        /** Formats total seconds into MM:SS format */
        function formatTime(totalSeconds) {
            if (totalSeconds === undefined || totalSeconds === null) totalSeconds = 0;
            const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${minutes}:${seconds}`;
        }
        
        /** Formats total seconds into readable string "X menit Y detik" */
        function formatTimeReadable(totalSeconds) {
            if (totalSeconds === undefined || totalSeconds === null) totalSeconds = 0;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            let parts = [];
            if (minutes > 0) parts.push(`${minutes} menit`);
            if (seconds > 0 || minutes === 0) parts.push(`${seconds} detik`);
            return parts.join(' ');
        }
        
        // --- MODAL (Manajemen Pegawai) LOGIC ---
        const modal = document.getElementById('employeeListModal');
        const modalContent = modal.querySelector('div');

        window.openModal = function() {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeModal = function() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                resetForm(); 
            }, 300); 
        }
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // --- NEW: GEMINI MODAL LOGIC ---
        const geminiModal = document.getElementById('geminiResultModal');
        const geminiModalContentEl = geminiModal.querySelector('div');
        const geminiModalTitle = document.getElementById('geminiModalTitle');
        const geminiModalContent = document.getElementById('geminiModalContent');

        window.openGeminiModal = function(title, content) {
            geminiModalTitle.textContent = title;
            geminiModalContent.textContent = content; // Gunakan textContent untuk keamanan
            
            geminiModal.classList.remove('hidden');
            geminiModal.classList.add('flex');
            setTimeout(() => {
                geminiModalContentEl.classList.remove('scale-95', 'opacity-0');
                geminiModalContentEl.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeGeminiModal = function() {
            geminiModalContentEl.classList.remove('scale-100', 'opacity-100');
            geminiModalContentEl.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                geminiModal.classList.remove('flex');
                geminiModal.classList.add('hidden');
            }, 300); 
        }
        
        geminiModal.addEventListener('click', (e) => {
            if (e.target === geminiModal) {
                closeGeminiModal();
            }
        });


        // --- GEMINI API CALL FUNCTION ---
        /**
         * Memanggil Gemini API dengan penanganan retry.
         * @param {string} systemPrompt - Instruksi sistem untuk model.
         * @param {string} userPrompt - Prompt dari pengguna.
         * @param {number} retries - Jumlah percobaan ulang.
         * @param {number} delay - Waktu tunggu awal (ms) untuk backoff.
         * @returns {Promise<string>} Teks respons dari Gemini.
         */
        async function callGeminiAPI(systemPrompt, userPrompt, retries = 3, delay = 1000) {
            showLoading(true);
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content?.parts?.[0]?.text) {
                        showLoading(false);
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        // Tangani jika respons ada tapi tidak ada konten (misal: diblokir)
                        const blockReason = result.candidates?.[0]?.finishReason;
                        if (blockReason) {
                            throw new Error(`Permintaan diblokir oleh Gemini. Alasan: ${blockReason}`);
                        }
                        throw new Error("Format respons Gemini tidak valid atau kosong.");
                    }

                } catch (error) {
                    console.error(`Gemini API call attempt ${i + 1} failed:`, error.message);
                    if (i === retries - 1) { // Percobaan terakhir gagal
                        showLoading(false);
                        showMessage(`Gagal menghubungi Gemini API setelah ${retries} percobaan. Error: ${error.message}`, "error");
                        return null;
                    }
                    // Menunggu sebelum mencoba lagi (exponential backoff)
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
            showLoading(false);
            return null; // Seharusnya tidak tercapai
        }

        // --- GEMINI FEATURE HANDLERS ---
        
        /** Menangani klik "Bantu Saya Cari Ide" */
        async function handleIdeaHelperClick() {
            const systemPrompt = "Anda adalah asisten kreatif yang membantu pengguna menemukan ide untuk permainan '3 Kebenaran 1 Kebohongan'. Berikan jawaban dalam bahasa Indonesia. Format jawaban sebagai daftar poin-poin singkat.";
            const userPrompt = "Berikan saya 7 kategori atau ide umum untuk pernyataan pribadi yang menarik (bukan pernyataan penuh, hanya kategori). Contoh: 'Keahlian tersembunyi', 'Tempat yang pernah dikunjungi', 'Phobia aneh', 'Makanan yang dibenci', 'Pengalaman memalukan', 'Cita-cita masa kecil'.";
            
            const resultText = await callGeminiAPI(systemPrompt, userPrompt);
            
            if (resultText) {
                openGeminiModal("✨ Bantuan Ide dari Gemini", resultText);
            }
        }

        /** Menangani klik "Buatkan Pernyataan Salah" */
        async function handleGenerateLieClick() {
            const stmt1 = document.getElementById('stmt1').value.trim();
            const stmt2 = document.getElementById('stmt2').value.trim();
            const stmt3 = document.getElementById('stmt3').value.trim();

            if (!stmt1 || !stmt2 || !stmt3) {
                showMessage("Harap isi 3 pernyataan benar terlebih dahulu untuk memberi konteks pada Gemini.", "warning");
                return;
            }

            const systemPrompt = "Anda adalah asisten kreatif yang ahli dalam permainan '3 Kebenaran 1 Kebohongan' (3 Truths 1 Lie). Tugas Anda adalah membuat satu pernyataan bohong (kebohongan) yang terdengar sangat masuk akal (plausible) berdasarkan tiga pernyataan benar yang diberikan oleh pengguna. Kebohongan ini harus kreatif, spesifik, dan sulit ditebak. Berikan HANYA teks kebohongannya, tanpa penjelasan atau pengantar. Jawab dalam bahasa Indonesia.";
            const userPrompt = `
Tiga pernyataan BENAR tentang saya adalah:
1. "${stmt1}"
2. "${stmt2}"
3. "${stmt3}"

Buatkan satu pernyataan BOHONG yang terdengar nyata, spesifik, dan sulit ditebak berdasarkan fakta-fakta di atas.
            `;
            
            const resultText = await callGeminiAPI(systemPrompt, userPrompt);
            
            if (resultText) {
                document.getElementById('stmt4').value = resultText.replace(/\"/g, ''); // Hapus tanda kutip jika ada
                showMessage("✨ Pernyataan salah (bohong) berhasil dibuat oleh Gemini!", "success");
            }
        }


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                // Determine which configuration to use (Global variables take precedence in Canvas)
                const effectiveFirebaseConfig = typeof __firebase_config !== 'undefined' 
                                            ? JSON.parse(__firebase_config) 
                                            : firebaseConfig;
                
                // Warn if user is using default/mock config and outside Canvas
                if (effectiveFirebaseConfig.apiKey === "AIzaSyABv2USzWH2QA3QNKiJmvCjI2N-IwYkUcM" && typeof __firebase_config === 'undefined') {
                    showMessage("Peringatan: Konfigurasi Firebase Anda belum diganti dari nilai contoh. Kemungkinan akan ada kegagalan koneksi/izin.", "warning");
                }


                const app = initializeApp(effectiveFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // CRITICAL FIX: Ensure user is authenticated to pass Firestore security rules (request.auth != null)
                if (typeof __initial_auth_token !== 'undefined') {
                    // Use custom token if provided by the environment (Canvas)
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Otherwise, sign in anonymously (required for external hosting/fallback)
                    await signInAnonymously(auth);
                }
                
                // Set userId from authenticated user
                userId = auth.currentUser.uid; 
                
                console.log("Firebase initialized. User ID:", userId);
                showMessage(`Login Berhasil! User ID: ${userId.substring(0, 8)}...`, 'success');
                
                // Start listening to all key data streams
                setupEmployeeDataListener();
                setupMonitoring();
                setupLeaderboard();
                
                // Try to load user display name if they have mapped it before
                if (db) {
                     const userMapRef = doc(db, userMapCollectionPath, userId);
                     const docSnap = await getDoc(userMapRef);
                     if (docSnap.exists()) {
                        const data = docSnap.data();
                        const checkEmployeeData = () => {
                            if (allEmployees.length > 0) {
                                const foundEmployee = allEmployees.find(e => e.id === data.employeeId);
                                if(foundEmployee){
                                    selectedEmployee = foundEmployee;
                                    employeeDisplayName = foundEmployee.name;
                                    updateUIForValidatedUser();
                                    checkUserSubmissionStatus();
                                    setupQuizProgressMonitoring(); 
                                }
                            } else {
                                setTimeout(checkEmployeeData, 100); 
                            }
                        };
                        checkEmployeeData();
                     }
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                if (error.code === 'auth/configuration-not-found' || error.message.includes('permission denied')) {
                    showMessage("LOGIN/KONEKSI GAGAL: Pastikan 'Anonymous Sign-In' telah diaktifkan di Firebase Console ANDA, dan semua konfigurasi (apiKey, projectId, dll) sudah benar.", "error");
                } else {
                    showMessage(`Gagal terhubung ke server. Error: ${error.message}`, "error");
                }
            }
        }

        // --- EMPLOYEE CRUD OPERATIONS ---
        const employeeForm = document.getElementById('employeeForm');
        
        window.resetForm = function() {
            employeeForm.reset();
            document.getElementById('employeeDocId').value = '';
            document.getElementById('formTitle').textContent = 'Tambah Pegawai Baru';
            document.getElementById('saveEmployeeButton').textContent = 'Simpan';
            document.getElementById('cancelEditButton').classList.add('hidden');
        }

        window.editEmployee = function(docId, name, id, username) {
            document.getElementById('employeeDocId').value = docId;
            document.getElementById('inputName').value = name;
            document.getElementById('inputId').value = id;
            document.getElementById('inputUsername').value = username;
            document.getElementById('formTitle').textContent = `Edit Pegawai: ${name}`;
            document.getElementById('saveEmployeeButton').textContent = 'Update';
            document.getElementById('cancelEditButton').classList.remove('hidden');
        }

        window.deleteEmployee = async function(docId, name) {
            const confirmed = await showConfirmation(`Apakah Anda yakin ingin menghapus pegawai "${name}"? Tindakan ini tidak dapat dibatalkan.`, 'Hapus', 'bg-red-600 hover:bg-red-700');
            if(confirmed) {
                try {
                    // Operasi ini memerlukan otentikasi
                    await deleteDoc(doc(db, employeeCollectionPath, docId));
                    showMessage(`Pegawai "${name}" berhasil dihapus.`, 'success');
                } catch (error) {
                    console.error("Error deleting employee: ", error);
                    showMessage(`Gagal menghapus pegawai. Error: ${error.message}`, "error");
                }
            }
        }
        
        employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('employeeDocId').value;
            const name = document.getElementById('inputName').value;
            const id = document.getElementById('inputId').value.toUpperCase();
            const username = document.getElementById('inputUsername').value.toLowerCase();

            if (!name || !id || !username) {
                showMessage("Semua field wajib diisi.", "error");
                return;
            }

            const employeeData = { name, id, username };
            
            try {
                // Operasi ini memerlukan otentikasi
                if (docId) { 
                    const docRef = doc(db, employeeCollectionPath, docId);
                    await updateDoc(docRef, employeeData);
                    showMessage("Data pegawai berhasil diperbarui.", 'success');
                } else { 
                    await addDoc(collection(db, employeeCollectionPath), employeeData);
                    showMessage("Pegawai baru berhasil ditambahkan.", 'success');
                }
                resetForm();
            } catch (error) {
                console.error("Error saving employee: ", error);
                showMessage(`Gagal menyimpan data pegawai. Error: ${error.message}`, "error");
            }
        });
        
        async function setupEmployeeDataListener() {
            try {
                const q = query(collection(db, employeeCollectionPath));
                
                // Cek jika koleksi kosong, tambahkan mock data jika ada
                // Operasi ini memerlukan otentikasi
                const initialSnapshot = await getDocs(q);
                if (initialSnapshot.empty && initialMockEmployees.length > 0) {
                    console.log("Employee collection is empty. Populating with mock data...");
                    const batch = [];
                    for (const emp of initialMockEmployees) {
                        // Menggunakan setDoc dengan ID kustom yang berasal dari ID Pegawai untuk mencegah duplikasi data
                        // NOTE: Firestore tidak mendukung ID kustom secara langsung saat menggunakan addDoc,
                        // sehingga menggunakan ID default dari Firestore atau setDoc dengan ID yang telah ditentukan (jika ID Pegawai unik).
                        // Karena ID Pegawai (P_001, P_002, dst) adalah ID unik yang bagus, kita gunakan itu sebagai Doc ID.
                        // Namun, menggunakan doc(collection, id) dan setDoc lebih baik daripada addDoc dalam kasus ini.
                        // Untuk kemudahan, kita biarkan `addDoc` dan biarkan Firestore membuat ID unik.
                        batch.push(addDoc(collection(db, employeeCollectionPath), emp));
                    }
                    await Promise.all(batch);
                    console.log("Mock data populated.");
                }

                onSnapshot(q, (snapshot) => {
                    const employees = [];
                    snapshot.forEach((doc) => {
                        employees.push({ docId: doc.id, ...doc.data() });
                    });
                    
                    allEmployees = employees.sort((a, b) => a.id.localeCompare(b.id));

                    renderEmployeeList(allEmployees);
                    renderMonitoringTable(allEmployees, allSubmissions);
                }, (error) => {
                    console.error("Error listening to employee data: ", error);
                    showMessage(`Gagal memuat data pegawai (Error: ${error.message}). Harap aktifkan login anonim.`, "error");
                });
            } catch (error) {
                 console.error("Error setting up employee listener: ", error);
                 showMessage(`Gagal memuat data pegawai (Error: ${error.message}). Harap aktifkan login anonim.`, "error");
            }
        }
        
        function renderEmployeeList(employees) {
            const tableBody = document.getElementById('employeeListTableBody');
            if (employees.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada data pegawai.</td></tr>';
                return;
            }
            
            tableBody.innerHTML = employees.map((emp, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${emp.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button onclick="editEmployee('${emp.docId}', '${emp.name}', '${emp.id}', '${emp.username}')" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button onclick="deleteEmployee('${emp.docId}', '${emp.name}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                </tr>
            `).join('');
        }

        // --- CORE APPLICATION LOGIC ---

        // Step 1: Validate Username
        document.getElementById('validateUsernameButton').addEventListener('click', async () => {
            const username = document.getElementById('usernameInput').value.trim().toLowerCase();
            if (!username) {
                showMessage("Username tidak boleh kosong.", "warning");
                return;
            }
            
            const foundEmployee = allEmployees.find(emp => emp.username === username);

            if (foundEmployee) {
                selectedEmployee = foundEmployee;
                employeeDisplayName = selectedEmployee.name; 
                
                try {
                    // Operasi ini memerlukan otentikasi
                    const userMapRef = doc(db, userMapCollectionPath, userId);
                    await setDoc(userMapRef, { employeeId: selectedEmployee.id, employeeName: selectedEmployee.name });
                    console.log(`User ${userId} mapped to employee ${selectedEmployee.id}`);
                } catch(error) {
                    console.error("Failed to map user:", error);
                    showMessage(`Gagal memetakan user (Error: ${error.message}). Pastikan login anonim aktif.`, "error");
                }

                updateUIForValidatedUser();
                await checkUserSubmissionStatus();
                setupQuizProgressMonitoring();
            } else {
                document.getElementById('selectionStatus').innerHTML = `
                    <span class="text-red-500 font-bold">❌ Username tidak ditemukan.</span> 
                    Pastikan username Anda benar atau hubungi administrator.
                `;
                document.getElementById('step2').classList.add('opacity-50', 'pointer-events-none');
            }
        });
        
        function updateUIForValidatedUser() {
             document.getElementById('selectionStatus').innerHTML = `
                <span class="text-green-600 font-bold">✔️ Validasi Berhasil!</span> 
                Selamat datang, <strong class="text-indigo-700">${selectedEmployee.name}</strong>. Silakan isi pernyataan di bawah.
            `;
            document.getElementById('employeeIdDisplay').textContent = `ID Pegawai Anda: ${selectedEmployee.id}`;
            document.getElementById('employeeIdDisplay').classList.remove('hidden');
            document.getElementById('usernameInput').value = selectedEmployee.username;
            document.getElementById('usernameInput').disabled = true;
            document.getElementById('validateUsernameButton').disabled = true;
            document.getElementById('step2').classList.remove('opacity-50', 'pointer-events-none');
        }

        // Step 2: Submit Statements
        document.getElementById('submitButton').addEventListener('click', async () => {
            if (!selectedEmployee) {
                showMessage("Harap validasi Username Anda terlebih dahulu.", "error");
                return;
            }

            const statements = [];
            const statementElements = document.querySelectorAll('.statement-item');
            let allFilled = true;

            statementElements.forEach(item => {
                const textarea = item.querySelector('textarea');
                const text = textarea.value.trim();
                if (!text) {
                    allFilled = false;
                }
                statements.push({
                    text: text,
                    status: item.dataset.status
                });
            });

            if (!allFilled) {
                showMessage("Semua empat pernyataan wajib diisi.", "error");
                return;
            }
            
            const confirmed = await showConfirmation(`Anda akan menyimpan pernyataan untuk ${selectedEmployee.name}. Apakah Anda yakin?`, 'Simpan', 'bg-indigo-600 hover:bg-indigo-700');
            if(!confirmed) return;

            showLoading(true);

            try {
                // Operasi ini memerlukan otentikasi
                const submissionData = {
                    employeeId: selectedEmployee.id,
                    employeeName: selectedEmployee.name,
                    username: selectedEmployee.username,
                    statements: statements,
                    submittedAt: new Date()
                };

                const docRef = doc(db, submissionCollectionPath, selectedEmployee.id);
                await setDoc(docRef, submissionData);

                showMessage("Pernyataan Anda berhasil disimpan!", "success");
                document.getElementById('submitButton').disabled = true;
                document.querySelectorAll('#step2 textarea').forEach(ta => ta.disabled = true);
                
                unlockQuizSection();

            } catch (error) {
                console.error("Error submitting statements: ", error);
                showMessage(`Gagal menyimpan pernyataan. Error: ${error.message}`, "error");
            } finally {
                showLoading(false);
            }
        });

        async function checkUserSubmissionStatus() {
            if (!selectedEmployee) return;
            try {
                // Operasi ini memerlukan otentikasi
                const docRef = doc(db, submissionCollectionPath, selectedEmployee.id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const textareas = document.querySelectorAll('#step2 textarea');
                    
                    const trueStatements = data.statements.filter(s => s.status === 'Benar');
                    const falseStatement = data.statements.find(s => s.status === 'Salah');
                    
                    textareas[0].value = trueStatements[0]?.text || '';
                    textareas[1].value = trueStatements[1]?.text || '';
                    textareas[2].value = trueStatements[2]?.text || '';
                    textareas[3].value = falseStatement?.text || '';

                    document.querySelectorAll('#step2 textarea').forEach(ta => ta.disabled = true);
                    document.getElementById('submitButton').disabled = true;
                    document.getElementById('submitButton').textContent = 'Data Sudah Tersimpan';
                    showMessage("Anda sudah mengisi pernyataan. Anda dapat memulai kuis.", 'info');
                    
                    unlockQuizSection();
                }
            } catch (error) {
                 console.error("Error checking submission status: ", error);
                 showMessage(`Gagal memeriksa status (Error: ${error.message}).`, "error");
            }
        }
        
        // Step 3: Monitoring
        function setupMonitoring() {
            const q = query(collection(db, submissionCollectionPath));
            // Operasi ini memerlukan otentikasi
            onSnapshot(q, (snapshot) => {
                const submissions = [];
                snapshot.forEach((doc) => {
                    submissions.push(doc.data());
                });
                allSubmissions = submissions;
                renderMonitoringTable(allEmployees, allSubmissions);
                
                totalEligibleQuestions = allSubmissions.filter(sub => sub.employeeId !== selectedEmployee?.id).length;
                updateQuizProgressDisplay();
            }, (error) => {
                console.error("Error listening to submissions: ", error);
                showMessage(`Gagal memuat data monitoring (Error: ${error.message}).`, "error");
            });
        }
        
        function renderMonitoringTable(employees, submissions) {
            const tableBody = document.getElementById('monitoringTableBody');
            const submittedIds = new Set(submissions.map(s => s.employeeId));
            
            if (employees.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Memuat data pegawai...</td></tr>';
                return;
            }

            tableBody.innerHTML = employees.map((emp, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${emp.name} <span class="text-gray-400">(${emp.id})</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${emp.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${submittedIds.has(emp.id)
                            ? '<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Sudah Mengisi</span>'
                            : '<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Belum Mengisi</span>'
                        }
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('totalEmployeesCount').textContent = employees.length;
            document.getElementById('submittedCount').textContent = submittedIds.size;
        }

        // --- QUIZ LOGIC (Step 4) ---

        // Timer Control Functions
        function startQuestionTimer() {
            stopQuestionTimer(); 
            
            const timerDisplay = document.getElementById('questionTimerDisplay');
            if (timerDisplay) timerDisplay.textContent = '00:00';
            
            questionStartTime = Date.now();
            currentQuestionTimeElapsed = 0;

            questionTimerInterval = setInterval(() => {
                currentQuestionTimeElapsed = Math.floor((Date.now() - questionStartTime) / 1000);
                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(currentQuestionTimeElapsed);
                }
            }, 1000);
        }

        function stopQuestionTimer() {
            if (questionTimerInterval) {
                clearInterval(questionTimerInterval);
                questionTimerInterval = null;
            }
            if (questionStartTime > 0) {
                 currentQuestionTimeElapsed = Math.floor((Date.now() - questionStartTime) / 1000);
            }
        }
        
        function unlockQuizSection() {
            document.getElementById('step4').classList.remove('opacity-50', 'pointer-events-none');
            const quizStatus = document.getElementById('quizStatus');
            const startQuizButton = document.getElementById('startQuizButton');

            const allFilled = allSubmissions.length >= 2; 
            const userHasFilled = allSubmissions.some(sub => sub.employeeId === selectedEmployee?.id);

            if (userHasFilled) {
                if (allFilled) {
                    quizStatus.textContent = '✅ Anda sudah siap! Tekan tombol di bawah untuk memulai Tantangan Kejujuran.';
                    startQuizButton.disabled = false;
                } else {
                    quizStatus.textContent = '⏳ Menunggu pegawai lain mengisi pernyataan agar kuis dapat dimulai (minimal 2 pengisi).';
                    startQuizButton.disabled = true;
                }
                startQuizButton.classList.remove('hidden');
            } else {
                 quizStatus.textContent = '❌ Anda harus mengisi pernyataan di Langkah 2 terlebih dahulu untuk memulai kuis.';
                 startQuizButton.classList.add('hidden');
            }
        }
        
        document.getElementById('startQuizButton').addEventListener('click', () => {
             document.getElementById('quizStatus').classList.add('hidden');
             document.getElementById('startQuizButton').classList.add('hidden');
             document.getElementById('quizContent').classList.remove('hidden');
             startQuiz();
        });
        
        function setupQuizProgressMonitoring() {
            if (!userId) return;
            // Operasi ini memerlukan otentikasi
            const leaderboardDocRef = doc(db, leaderboardCollectionPath, userId);
            onSnapshot(leaderboardDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    quizzesTakenIds = new Set(data.quizzesTakenIds || []);
                    currentScore = data.score || 0;
                    totalAccumulatedTime = data.totalAccumulatedTime || 0; 
                    document.getElementById('userScoreDisplay').textContent = currentScore;
                } else {
                    quizzesTakenIds = new Set();
                    currentScore = 0;
                    totalAccumulatedTime = 0; 
                    document.getElementById('userScoreDisplay').textContent = 0;
                }
                updateQuizProgressDisplay();
            }, (error) => {
                console.error("Error listening to leaderboard progress: ", error);
                showMessage(`Gagal memuat progres kuis (Error: ${error.message}).`, "error");
            });
        }
        
        function startQuiz() {
            if (!selectedEmployee) {
                showMessage("Pegawai tidak terautentikasi. Harap validasi username Anda.", "error");
                return;
            }

            const quizPool = allSubmissions.filter(sub => {
                return sub.employeeId !== selectedEmployee.id && !quizzesTakenIds.has(sub.employeeId);
            });

            if (quizPool.length === 0) {
                showQuizEnd();
                return;
            }

            const randomIndex = Math.floor(Math.random() * quizPool.length);
            currentQuizData = quizPool[randomIndex];
            
            renderQuizQuestion(currentQuizData);
            startQuestionTimer(); 
        }
        
        function renderQuizQuestion(quizData) {
            document.getElementById('quizEmployeeName').textContent = quizData.employeeName;
            
            const optionsContainer = document.getElementById('quizOptionsContainer');
            const shuffledStatements = [...quizData.statements].sort(() => Math.random() - 0.5);

            optionsContainer.innerHTML = shuffledStatements.map(stmt => `
                <div class="quiz-option p-4 bg-white border-2 border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-400" 
                     data-status="${stmt.status}"
                     onclick="selectAnswer(this)">
                    ${stmt.text}
                </div>
            `).join('');
            
            document.getElementById('quizFeedback').classList.add('hidden');
            document.getElementById('nextQuizButton').classList.add('hidden');
            const timerDisplay = document.getElementById('questionTimerDisplay');
            if(timerDisplay) timerDisplay.textContent = '00:00';
        }

        window.selectAnswer = async function(selectedOption) {
            stopQuestionTimer(); 
            
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.classList.remove('hover:bg-indigo-50', 'hover:border-indigo-400');
            });

            const isCorrect = selectedOption.dataset.status === 'Salah';
            const feedback = document.getElementById('quizFeedback');
            
            if (isCorrect) {
                selectedOption.classList.add('correct-answer');
                feedback.textContent = 'Jawaban Benar! Anda mendapatkan 10 poin.';
                feedback.className = 'mt-4 p-3 rounded-lg font-semibold text-center text-green-800 bg-green-100';
                currentScore += 10;
            } else {
                selectedOption.classList.add('incorrect-answer');
                feedback.textContent = 'Jawaban Salah. Poin Anda tidak bertambah.';
                feedback.className = 'mt-4 p-3 rounded-lg font-semibold text-center text-red-800 bg-red-100';
                
                 document.querySelector('.quiz-option[data-status="Salah"]').classList.add('correct-answer');
            }

            feedback.classList.remove('hidden');
            document.getElementById('nextQuizButton').classList.remove('hidden');
            document.getElementById('userScoreDisplay').textContent = currentScore;
            
            quizzesTakenIds.add(currentQuizData.employeeId);
            totalAccumulatedTime += currentQuestionTimeElapsed;

            try {
                // Operasi ini memerlukan otentikasi
                const leaderboardDocRef = doc(db, leaderboardCollectionPath, userId);
                await setDoc(leaderboardDocRef, {
                    score: currentScore,
                    quizzesTakenIds: Array.from(quizzesTakenIds),
                    employeeName: selectedEmployee.name,
                    employeeId: selectedEmployee.id,
                    totalAccumulatedTime: totalAccumulatedTime, 
                    lastUpdated: new Date()
                }, { merge: true });
            } catch (error) {
                console.error("Failed to update score:", error);
                showMessage(`Gagal menyimpan skor Anda (Error: ${error.message}).`, "error");
            }
             updateQuizProgressDisplay();
        }
        
        document.getElementById('nextQuizButton').addEventListener('click', startQuiz);
        
        function showQuizEnd() {
            stopQuestionTimer(); 
            const quizArea = document.getElementById('quizArea');
            
            quizArea.innerHTML = `
                <h3 class="text-2xl font-bold text-green-700">Tantangan Selesai!</h3>
                <p class="mt-2 text-gray-700 text-center">Anda telah menjawab semua pertanyaan yang tersedia. Terima kasih atas partisipasi Anda!</p>
                <div class="mt-6 bg-white p-4 rounded-lg shadow-md border divide-y">
                    <div class="py-3">
                        <p class="text-lg">Skor Akhir Anda:</p>
                        <p class="text-4xl font-extrabold text-indigo-600">${currentScore} Poin</p>
                    </div>
                    <div class="pt-3">
                        <p class="text-lg">Total Waktu Mengerjakan:</p>
                        <p class="text-2xl font-bold text-gray-800">${formatTimeReadable(totalAccumulatedTime)}</p>
                    </div>
                </div>
            `;
        }

        // --- LEADERBOARD (Step 5) ---
        function setupLeaderboard() {
            const q = query(collection(db, leaderboardCollectionPath));
            // Operasi ini memerlukan otentikasi
            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push({ ...doc.data() });
                });
                
                // Sort by score (desc), then time (asc)
                const sortedScores = scores.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    return (a.totalAccumulatedTime || 0) - (b.totalAccumulatedTime || 0);
                });
                renderLeaderboard(sortedScores);
            }, (error) => {
                console.error("Error listening to leaderboard: ", error);
                showMessage(`Gagal memuat papan skor (Error: ${error.message}).`, "error");
            });
        }
        
        function renderLeaderboard(scores) {
            const tableBody = document.getElementById('leaderboardTableBody');
            if (scores.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">Belum ada skor yang tercatat.</td></tr>';
                return;
            }
            
            tableBody.innerHTML = scores.map((entry, index) => {
                const rankClass = index === 0 ? 'text-amber-500' : (index === 1 ? 'text-slate-500' : (index === 2 ? 'text-orange-700' : 'text-gray-900'));
                const rankIcon = index === 0 ? '🏆' : (index === 1 ? '🥈' : (index === 2 ? '🥉' : ''));
                const totalTime = entry.totalAccumulatedTime || 0;
                
                return `
                     <tr class="hover:bg-gray-50 ${entry.employeeId === selectedEmployee?.id ? 'bg-indigo-50 font-bold' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${rankClass}">${index + 1} ${rankIcon}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${entry.employeeName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-indigo-600">${entry.score}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-600">${formatTime(totalTime)}</td>
                    </tr>
                `;
            }).join('');
        }

        // --- INITIALIZE ON PAGE LOAD ---
        window.onload = function() {
            initializeFirebase();

            // Pasang event listener untuk tombol Gemini
            document.getElementById('ideaHelperButton').addEventListener('click', handleIdeaHelperClick);
            document.getElementById('generateLieButton').addEventListener('click', handleGenerateLieClick);
        };

    </script>
</body>
</html>


